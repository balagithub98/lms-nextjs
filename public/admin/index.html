<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:#f5f5f5; }
      .loading, .error { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; }
      .card { background:#fff; padding:28px; border-radius:10px; box-shadow:0 6px 24px rgba(0,0,0,.12); width:min(560px,92vw); }
      .spinner { border:4px solid #f3f3f3; border-top:4px solid #007bff; border-radius:50%; width:40px; height:40px; animation: spin 1s linear infinite; margin:0 auto 16px; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .btn { display:inline-block; padding:10px 16px; background:#007bff; color:#fff; text-decoration:none; border-radius:6px; margin-top:12px; }
      code { background:#f6f8fa; padding:2px 6px; border-radius:4px; }
    </style>
  </head>
  <body>
    <!-- Decap mounts here. We don't touch this element once CMS starts. -->
    <div id="nc-root"></div>

    <!-- Lightweight pre-init overlay; we will just hide it (not remove children) -->
    <div id="loader" class="loading">
      <div class="card">
        <div class="spinner"></div>
        <h2 style="margin:0 0 8px">Loading Decap CMS…</h2>
        <p style="margin:0;opacity:.8">Please wait while the CMS initializes.</p>
      </div>
    </div>

    <script>
      (function () {
        const SOURCES = [
          "https://cdn.jsdelivr.net/npm/decap-cms@^3/dist/decap-cms.js",
          "https://unpkg.com/decap-cms@^3/dist/decap-cms.js"
        ];
        let started = false;     // prevent double init
        let scriptLoaded = false;

        function hideLoader() {
          const el = document.getElementById("loader");
          if (el) el.style.display = "none"; // hide; don't remove children
        }

        function showError(msg) {
          const el = document.getElementById("loader");
          if (!el) return;
          el.innerHTML = '<div class="card"><h3>❌ Decap failed to load</h3><p style="opacity:.85"></p><a class="btn" href="/admin">Reload</a></div>';
          el.querySelector("p").textContent = msg || "Unknown error.";
        }

        function safeInit() {
          if (started) return;
          if (!window.CMS) return;
          started = true;
          try {
            window.CMS.init();     // uses /admin/config.yml by default
            hideLoader();
          } catch (e) {
            showError("Init error: " + (e && e.message ? e.message : e));
          }
        }

        function inject(i) {
          if (i >= SOURCES.length) {
            showError("Could not load Decap from any CDN.");
            return;
          }
          const s = document.createElement("script");
          s.src = SOURCES[i];
          s.async = true;
          s.onload = function () { scriptLoaded = true; safeInit(); };
          s.onerror = function () { inject(i + 1); };
          document.head.appendChild(s);
        }

        // Keep polling briefly until CMS appears, then init once.
        const t = setInterval(function(){
          if (window.CMS) {
            clearInterval(t);
            safeInit();
          }
        }, 120);

        // Hard timeout guard
        setTimeout(function(){
          if (!scriptLoaded || !window.CMS) {
            showError("Timeout waiting for Decap CMS to load from CDN.");
          }
        }, 15000);

        inject(0);
      })();
    </script>
  </body>
</html>